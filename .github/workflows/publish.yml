name: test & release

# Run the workflow when a Pull Request is opened or when changes are pushed to master
on:
 pull_request:
 push:
  branches:
    - master
    - feature/githubaction

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
    matrix:
      # Run the steps below with the following versions of Node.js
      node-version: [10.x, 12.x, 14.x]
    steps:
    # Fetch the latest commit
    - name: Checkout
      uses: actions/checkout@v2

    # Setup Node.js using the appropriate version
    - name: Use Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v1
      with:
        node-version: ${{ matrix.node-version }}

    - name: Start Neo4j
      uses: baptouuuu/setup-neo4j@v1.0.0
      with:
        tag: '4.1.0'

    - name: Start MongoDB
      uses: supercharge/mongodb-github-action@1.3.0
      with:
        mongodb-version: 4.2

    # Install package dependencies
    - name: Install
      run: npm install

    # Run tests
    - name: Test
      run: npm test-ci
      env:
        NEO_PASS: ci
        NEO_USER: neo4j
        NEO_URI: neo4j://localhost:7687

# -------------------------------------------------------------
# Release
# -------------------------------------------------------------
  release:
  # Only release on push to master
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'
    runs-on: ubuntu-latest
    # Waits for test jobs for each Node.js version to complete
    needs: [test]
    steps:
    - name: Checkout
      uses: actions/checkout@v2

    - name: Setup Node.js
      uses: actions/setup-node@v1
      with:
        node-version: 14.x

    - name: Start Neo4j
      uses: baptouuuu/setup-neo4j@v1.0.0
      with:
        tag: '4.1.0'

    - name: Start MongoDB
      uses: supercharge/mongodb-github-action@1.3.0
      with:
        mongodb-version: 4.2

    - name: Install
      run: npm i

    - name: Release
      run: npm run semantic-release && npm run coveralls
      env:
        GH_TOKEN: ${{ secrets.GH_TOKEN }}
        NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
        COVERALLS_REPO_TOKEN: ${{ secrets.COVERALLS_REPO_TOKEN }}
        NEO_PASS: ci
        NEO_USER: neo4j
        NEO_URI: neo4j://localhost:7687
